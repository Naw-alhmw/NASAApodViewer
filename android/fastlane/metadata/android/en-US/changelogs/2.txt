bug fixes and style adjustment